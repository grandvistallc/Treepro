<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout | TreePro Services</title>
  <meta name="description" content="Complete your tree service and yard cleanup booking. Review your appointment details and confirm your professional tree service with TreePro Services.">

  <!-- Favicon - Icon displayed in browser tab and bookmarks -->
  <link rel="icon" type="image/png" href="/favicon.png">

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-SWCX8FXK49"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-SWCX8FXK49');
    gtag('config', 'AW-16997068616');
  </script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --green: #10b981;
      --green-dark: #059669;
      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-900: #0f172a;
      --gray-600: #64748b;
      --orange: #F97316;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      line-height: 1.6;
      color: var(--gray-900);
      background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
      min-height: 100vh;
    }

    .navbar {
      background: white;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 700;
      font-size: 1.25rem;
      color: var(--gray-900);
      text-decoration: none;
    }

    .logo-img {
      height: 80px;
      width: auto;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--green) 0%, var(--green-dark) 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }

    .nav-links {
      display: flex;
      gap: 2rem;
      list-style: none;
    }

    .nav-links a {
      color: var(--gray-600);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s;
    }

    .nav-links a:hover {
      color: var(--green);
    }

    /* Hide navigation links on mobile */
    @media (max-width: 768px) {
      .nav-links {
        display: none;
      }
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 2rem;
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 2rem;
    }

    .main-content {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      height: fit-content;
    }

    .sidebar {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      height: fit-content;
      position: sticky;
      top: 100px;
    }

    .header {
      margin-bottom: 2rem;
    }

    .title {
      font-size: 2rem;
      font-weight: 800;
      color: var(--gray-900);
      margin-bottom: 0.5rem;
    }

    .subtitle {
      color: var(--gray-600);
      font-size: 1.125rem;
    }

    /* Order Summary */
    .order-summary h3 {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 1.5rem;
    }

    .summary-section {
      border-bottom: 1px solid #f1f5f9;
      padding-bottom: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .summary-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.75rem;
    }

    .summary-item:last-child {
      margin-bottom: 0;
    }

    .summary-label {
      color: var(--gray-600);
      font-weight: 500;
      flex: 1;
    }

    .summary-value {
      font-weight: 600;
      color: var(--gray-900);
      text-align: right;
    }

    .total-price {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--green);
      background: #f0fdf4;
      padding: 1rem;
      border-radius: 12px;
      text-align: center;
      margin: 1.5rem 0;
    }

    /* Service Details */
    .service-card {
      background: #f8fafc;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      border-left: 4px solid var(--green);
    }

    .service-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .service-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, var(--green) 0%, var(--green-dark) 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: white;
    }

    .service-info h4 {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 0.25rem;
    }

    .service-info p {
      color: var(--gray-600);
      font-size: 0.9rem;
    }

    /* Appointment Details */
    .appointment-details {
      background: #f8fafc;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      border-left: 4px solid var(--orange);
    }

    .detail-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid #e5e7eb;
    }

    .detail-item:last-child {
      border-bottom: none;
    }

    .detail-label {
      color: var(--gray-600);
      font-weight: 500;
    }

    .detail-value {
      font-weight: 600;
      color: var(--gray-900);
    }

    /* Customer Information */
    .customer-info {
      background: #f8fafc;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .info-item {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .info-label {
      color: var(--gray-600);
      font-weight: 500;
      font-size: 0.875rem;
    }

    .info-value {
      font-weight: 600;
      color: var(--gray-900);
    }

    /* Important Notice */
    .notice {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: #92400e;
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 2rem;
    }

    .notice h4 {
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .notice p {
      font-size: 0.9rem;
      line-height: 1.5;
    }

    /* Buttons */
    .button-group {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      font-weight: 700;
      font-size: 0.95rem;
      text-decoration: none;
      transition: all 0.2s;
      border: none;
      cursor: pointer;
      text-align: center;
      display: inline-block;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--green) 0%, var(--green-dark) 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
    }

    .btn-secondary {
      background: white;
      color: var(--gray-600);
      border: 2px solid #e5e7eb;
    }

    .btn-secondary:hover {
      border-color: var(--gray-600);
      color: var(--gray-900);
    }

    .confirm-btn {
      width: 100%;
      background: linear-gradient(135deg, var(--green) 0%, var(--green-dark) 100%);
      color: white;
      padding: 1.25rem;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1.125rem;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: block;
      text-align: center;
    }

    .confirm-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
    }

    /* Mobile Styles */
    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
        gap: 1rem;
        padding: 1rem;
      }

      .sidebar {
        position: static;
        order: -1;
      }

      .info-grid {
        grid-template-columns: 1fr;
      }

      .button-group {
        flex-direction: column;
      }

      .btn {
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-container">
      <a href="index.html" class="logo">
        <img src="/Images/Logo.png" alt="TreePro Services Logo" class="logo-img">
      </a>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="services.html">Services</a></li>
        <li><a href="Contact.html">Contact</a></li>
      </ul>
      <a href="tel:651-508-3194" class="btn btn-primary">Call (651) 508-3194</a>
    </div>
  </nav>

  <div class="container">
    <!-- Main Content -->
    <div class="main-content">
      <div class="header">
        <h1 class="title">Confirm Your Booking</h1>
        <p class="subtitle">Please review your tree service appointment details before confirming.</p>
      </div>

      <!-- Service Details -->
      <div class="service-card">
        <div class="service-header">
          <div class="service-icon" id="service-icon">üå≥</div>
          <div class="service-info">
            <h4 id="service-name">Tree Service</h4>
            <p id="service-description">Professional tree care</p>
          </div>
        </div>
      </div>

      <!-- Appointment Details -->
      <div class="appointment-details">
        <h4 style="margin-bottom: 1rem; color: var(--gray-900); font-weight: 700;">Appointment Details</h4>
        <div class="detail-item">
          <span class="detail-label">Date:</span>
          <span class="detail-value" id="appointment-date">-</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Time:</span>
          <span class="detail-value" id="appointment-time">-</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Service Address:</span>
          <span class="detail-value" id="service-address">-</span>
        </div>
      </div>

      <!-- Customer Information -->
      <div class="customer-info">
        <h4 style="margin-bottom: 1rem; color: var(--gray-900); font-weight: 700;">Customer Information</h4>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Name</span>
            <span class="info-value" id="customer-name">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">Phone</span>
            <span class="info-value" id="customer-phone">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">Email</span>
            <span class="info-value" id="customer-email">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">Notes</span>
            <span class="info-value" id="customer-notes">None provided</span>
          </div>
        </div>
      </div>

      <!-- Important Notice -->
      <div class="notice">
        <h4>üìã Important Information</h4>
        <p>‚Ä¢ A TreePro Services representative will contact you within 24 hours to confirm your appointment<br>
        ‚Ä¢ Please ensure the work area is accessible and free from obstacles<br>
        ‚Ä¢ All work is fully insured and performed by certified arborists<br>
        ‚Ä¢ Weather conditions may affect scheduling - we'll notify you of any changes</p>
      </div>

      <!-- Buttons -->
      <div class="button-group">
        <a href="datetime.html" class="btn btn-secondary">‚Üê Back to Schedule</a>
        <button class="btn btn-primary" onclick="confirmBooking()">Confirm Booking</button>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
      <div class="order-summary">
        <h3>Order Summary</h3>
        
        <div class="summary-section">
          <div class="summary-item">
            <span class="summary-label">Service:</span>
            <span class="summary-value" id="summary-service">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Type:</span>
            <span class="summary-value" id="summary-type">-</span>
          </div>
        </div>

        <div class="summary-section">
          <div class="summary-item">
            <span class="summary-label">Base Price:</span>
            <span class="summary-value" id="summary-price">$0</span>
          </div>
          <div class="summary-item" id="tax-row" style="display: none;">
            <span class="summary-label">Sales Tax:</span>
            <span class="summary-value" id="summary-tax">$0</span>
          </div>
          <div class="summary-item" id="tax-location" style="display: none; font-size: 0.8em; color: var(--gray-600);">
            <span class="summary-label">Tax Location:</span>
            <span class="summary-value" id="tax-county">-</span>
          </div>
        </div>

        <div class="total-price" id="total-amount">$0</div>

        <a href="thankyou.html" class="confirm-btn" id="confirm-btn" style="display: none;">
          Confirm & Book Service
        </a>
      </div>
    </div>
  </div>

  <script>
    let bookingData = null;

    function loadBookingData() {
      console.log('Loading booking data...');
      const storedData = sessionStorage.getItem('bookingData');
      console.log('Stored data:', storedData);
      
      if (storedData) {
        try {
          bookingData = JSON.parse(storedData);
          console.log('Parsed booking data:', bookingData);
          populateOrderSummary();
          populateBookingDetails();
        } catch (error) {
          console.error('Error parsing booking data:', error);
          window.location.href = 'services.html';
        }
      } else {
        console.log('No booking data found, redirecting to services');
        // Redirect back if no booking data
        window.location.href = 'services.html';
      }
    }

    // Tax calculation based on customer address
    function calculateSalesTax(address, servicePrice) {
      // Minnesota county tax rates (as of 2025)
      const countyTaxRates = {
        'aitkin': 0.07875,          // 7.875%
        'anoka': 0.08375,           // 8.375%
        'becker': 0.07875,          // 7.875%
        'beltrami': 0.085,          // 8.5%
        'benton': 0.07875,          // 7.875%
        'big stone': 0.06875,       // 6.875%
        'blue earth': 0.07875,      // 7.875%
        'brown': 0.07875,           // 7.875%
        'carlton': 0.08875,         // 8.875%
        'carver': 0.09025,          // 9.025%
        'cass': 0.08875,            // 8.875%
        'chippewa': 0.07375,        // 7.375%
        'chisago': 0.08375,         // 8.375%
        'clay': 0.07875,            // 7.875%
        'clearwater': 0.08,         // 8%
        'cook': 0.08375,            // 8.375%
        'cottonwood': 0.07875,      // 7.875%
        'crow wing': 0.07875,       // 7.875%
        'dakota': 0.08625,          // 8.625%
        'dodge': 0.07375,           // 7.375%
        'douglas': 0.07375,         // 7.375%
        'faribault': 0.07375,       // 7.375%
        'fillmore': 0.07625,        // 7.625%
        'freeborn': 0.07875,        // 7.875%
        'goodhue': 0.08125,         // 8.125%
        'grant': 0.07375,           // 7.375%
        'hennepin': 0.09875,        // 9.875% (Minneapolis area)
        'houston': 0.07625,         // 7.625%
        'hubbard': 0.08875,         // 8.875%
        'isanti': 0.08125,          // 8.125%
        'itasca': 0.08375,          // 8.375%
        'jackson': 0.07875,         // 7.875%
        'kanabec': 0.07375,         // 7.375%
        'kandiyohi': 0.07875,       // 7.875%
        'kittson': 0.07375,         // 7.375%
        'koochiching': 0.07875,     // 7.875%
        'lac qui parle': 0.06875,   // 6.875%
        'lake': 0.08375,            // 8.375%
        'lake of the woods': 0.07375, // 7.375%
        'le sueur': 0.08375,        // 8.375%
        'lincoln': 0.06875,         // 6.875%
        'lyon': 0.07375,            // 7.375%
        'mahnomen': 0.07375,        // 7.375%
        'marshall': 0.07375,        // 7.375%
        'martin': 0.07875,          // 7.875%
        'mcleod': 0.08375,          // 8.375%
        'meeker': 0.075,            // 7.5%
        'mille lacs': 0.07375,      // 7.375%
        'morrison': 0.075,          // 7.5%
        'mower': 0.07875,           // 7.875%
        'murray': 0.07875,          // 7.875%
        'nicollet': 0.07875,        // 7.875%
        'nobles': 0.07875,          // 7.875%
        'norman': 0.07375,          // 7.375%
        'olmsted': 0.08125,         // 8.125%
        'otter tail': 0.07875,      // 7.875%
        'pennington': 0.07375,      // 7.375%
        'pine': 0.07875,            // 7.875%
        'pipestone': 0.07375,       // 7.375%
        'polk': 0.08375,            // 8.375%
        'pope': 0.07375,            // 7.375%
        'ramsey': 0.09875,          // 9.875% (St. Paul area)
        'red lake': 0.07375,        // 7.375%
        'redwood': 0.07375,         // 7.375%
        'renville': 0.07375,        // 7.375%
        'rice': 0.08375,            // 8.375%
        'rock': 0.07375,            // 7.375%
        'roseau': 0.08,             // 8%
        'scott': 0.08375,           // 8.375%
        'sherburne': 0.08125,       // 8.125%
        'sibley': 0.08375,          // 8.375%
        'st louis': 0.08875,        // 8.875% (Duluth area)
        'saint louis': 0.08875,     // 8.875% (Alternative spelling)
        'stearns': 0.085,           // 8.5%
        'steele': 0.07875,          // 7.875%
        'stevens': 0.06875,         // 6.875%
        'swift': 0.07375,           // 7.375%
        'todd': 0.075,              // 7.5%
        'traverse': 0.06875,        // 6.875%
        'wabasha': 0.07625,         // 7.625%
        'wadena': 0.07875,          // 7.875%
        'waseca': 0.07375,          // 7.375%
        'washington': 0.08875,      // 8.875%
        'watonwan': 0.07875,        // 7.875%
        'wilkin': 0.07375,          // 7.375%
        'winona': 0.07625,          // 7.625%
        'wright': 0.08775,          // 8.775%
        'yellow medicine': 0.07375, // 7.375%
        'default': 0.06875          // Default Minnesota state rate (6.875%)
      };

      // Extract county from address (simple parsing)
      let county = 'default';
      let taxLocation = 'Minnesota Standard Rate';
      
      if (address) {
        const addressLower = address.toLowerCase();
        
        // Look for county names in the address
        for (const [countyName, rate] of Object.entries(countyTaxRates)) {
          if (countyName !== 'default' && addressLower.includes(countyName)) {
            county = countyName;
            taxLocation = countyName.replace(/\b\w/g, l => l.toUpperCase()) + ' County, MN';
            break;
          }
        }
        
        // Also check for common city names that indicate counties
        const cityToCounty = {
          'minneapolis': 'hennepin',
          'saint paul': 'ramsey',
          'st paul': 'ramsey',
          'rochester': 'olmsted',
          'duluth': 'st louis',
          'bloomington': 'hennepin',
          'brooklyn park': 'hennepin',
          'plymouth': 'hennepin',
          'woodbury': 'washington',
          'st cloud': 'stearns',
          'saint cloud': 'stearns',
          'eagan': 'dakota',
          'burnsville': 'dakota',
          'eden prairie': 'hennepin',
          'minnetonka': 'hennepin',
          'blaine': 'anoka',
          'lakeville': 'dakota',
          'maple grove': 'hennepin',
          'coon rapids': 'anoka',
          'burnsville': 'dakota',
          'apple valley': 'dakota',
          'edina': 'hennepin',
          'st louis park': 'hennepin',
          'moorhead': 'clay',
          'mankato': 'blue earth',
          'shakopee': 'scott',
          'cottage grove': 'washington',
          'inver grove heights': 'dakota',
          'roseville': 'ramsey',
          'brooklyn center': 'hennepin',
          'fridley': 'anoka',
          'richfield': 'hennepin',
          'prior lake': 'scott',
          'maplewood': 'ramsey',
          'new brighton': 'ramsey',
          'crystal': 'hennepin',
          'golden valley': 'hennepin',
          'robbinsdale': 'hennepin',
          'new hope': 'hennepin',
          'hopkins': 'hennepin',
          'st anthony': 'hennepin',
          'columbia heights': 'anoka',
          'white bear lake': 'ramsey',
          'rosemount': 'dakota',
          'chaska': 'carver',
          'chanhassen': 'carver',
          'austin': 'mower',
          'faribault': 'rice',
          'owatonna': 'steele',
          'northfield': 'rice',
          'albert lea': 'freeborn',
          'winona': 'winona',
          'red wing': 'goodhue',
          'hastings': 'dakota',
          'stillwater': 'washington',
          'forest lake': 'washington',
          'anoka': 'anoka',
          'elk river': 'sherburne',
          'ham lake': 'anoka',
          'andover': 'anoka',
          'ramsey': 'anoka',
          'cambridge': 'isanti',
          'isanti': 'isanti',
          'monticello': 'wright',
          'buffalo': 'wright',
          'delano': 'wright',
          'hutchinson': 'mcleod',
          'willmar': 'kandiyohi',
          'alexandria': 'douglas',
          'brainerd': 'crow wing',
          'little falls': 'morrison',
          'st joseph': 'stearns',
          'sartell': 'stearns',
          'sauk rapids': 'benton',
          'grand rapids': 'itasca',
          'hibbing': 'st louis',
          'virginia': 'st louis',
          'eveleth': 'st louis',
          'chisholm': 'st louis',
          'international falls': 'koochiching',
          'bemidji': 'beltrami',
          'crookston': 'polk',
          'thief river falls': 'pennington',
          'fergus falls': 'otter tail',
          'detroit lakes': 'becker',
          'new ulm': 'brown',
          'marshall': 'lyon',
          'worthington': 'nobles',
          'pipestone': 'pipestone',
          'luverne': 'rock'
        };
        
        for (const [city, countyName] of Object.entries(cityToCounty)) {
          if (addressLower.includes(city)) {
            county = countyName;
            const cityProper = city.replace(/\b\w/g, l => l.toUpperCase());
            const countyProper = countyName.replace(/\b\w/g, l => l.toUpperCase());
            taxLocation = `${cityProper} (${countyProper} County, MN)`;
            break;
          }
        }
      }

      const taxRate = countyTaxRates[county];
      const taxAmount = parseFloat(servicePrice) * taxRate;
      const totalAmount = parseFloat(servicePrice) + taxAmount;

      // Update tax display - show tax rows and update values
      document.getElementById('summary-tax').textContent = `$${taxAmount.toFixed(2)}`;
      document.getElementById('tax-county').textContent = taxLocation + ` (${(taxRate * 100).toFixed(3)}%)`;
      document.getElementById('total-amount').textContent = `$${totalAmount.toFixed(2)}`;
      
      // Show tax rows
      document.getElementById('tax-row').style.display = 'flex';
      document.getElementById('tax-location').style.display = 'flex';

      // Store tax info for booking submission
      if (bookingData) {
        bookingData.tax = {
          location: taxLocation,
          rate: taxRate,
          amount: taxAmount,
          total: totalAmount
        };
      }
    }

    function populateOrderSummary() {
      if (!bookingData) {
        console.error('No booking data found');
        return;
      }

      console.log('Booking data:', bookingData);
      const service = bookingData.service;
      
      if (!service) {
        console.error('No service data found in booking data');
        return;
      }

      // Service icons
      const iconMap = {
        'tree-removal': 'ü™ö',
        'tree-trimming': '‚úÇÔ∏è',
        'emergency-services': 'üö®'
      };

      // Update summary
      document.getElementById('summary-service').textContent = service.packageName;
      document.getElementById('summary-price').textContent = `$${service.price}`;
      
      // Calculate and display tax
      if (bookingData.customer && bookingData.customer.address) {
        calculateSalesTax(bookingData.customer.address, service.price);
      } else {
        // Fallback if no address - use default rate
        calculateSalesTax('', service.price);
      }

      // Update service type
      let serviceType = 'Professional tree care';
      if (service.size) {
        const sizeNames = {
          small: 'Small Tree (Under 30ft)',
          medium: 'Medium Tree (30-60ft)',  
          large: 'Large Tree (Over 60ft)',
          'small-property': 'Small Property (Under 0.5 acre)',
          'medium-property': 'Medium Property (0.5-1 acre)',
          'large-property': 'Large Property (1+ acres)'
        };
        serviceType = sizeNames[service.size];
      } else if (service.urgency) {
        const urgencyNames = {
          immediate: 'Immediate Response',
          'same-day': 'Same Day Service',
          'small-property': 'Small Property (Under 0.5 acre)',
          'medium-property': 'Medium Property (0.5-1 acre)',
          'large-property': 'Large Property (1+ acres)'
        };
        serviceType = urgencyNames[service.urgency];
      }
      document.getElementById('summary-type').textContent = serviceType;
    }

    function populateBookingDetails() {
      if (!bookingData) return;

      const service = bookingData.service;
      const customer = bookingData.customer;
      
      // Service details
      const iconMap = {
        'tree-removal': 'ü™ö',
        'tree-trimming': '‚úÇÔ∏è',
        'yard-cleanup': 'üçÇ',
        'emergency-services': 'üö®'
      };

      document.getElementById('service-icon').textContent = iconMap[service.package] || 'üå≥';
      document.getElementById('service-name').textContent = service.packageName;
      
      let description = 'Professional tree care service';
      if (service.size) {
        const sizeNames = {
          small: 'Small Tree (Under 30ft)',
          medium: 'Medium Tree (30-60ft)',
          large: 'Large Tree (Over 60ft)',
          'small-property': 'Small Property (Under 0.5 acre)',
          'medium-property': 'Medium Property (0.5-1 acre)',
          'large-property': 'Large Property (1+ acres)'
        };
        description = sizeNames[service.size];
      } else if (service.urgency) {
        const urgencyNames = {
          immediate: 'Immediate Response (Within 2 hours)',
          'same-day': 'Same Day Service (Within 8 hours)',
          'small-property': 'Small Property (Under 0.5 acre)',
          'medium-property': 'Medium Property (0.5-1 acre)',
          'large-property': 'Large Property (1+ acres)'
        };
        description = urgencyNames[service.urgency];
      }
      document.getElementById('service-description').textContent = description;

      // Appointment details
      const appointmentDate = new Date(bookingData.date);
      const dateDisplay = appointmentDate.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      
      // Enhanced time display with more context
      const timeDisplay = `${bookingData.time} (${getTimeContext(bookingData.time)})`;
      
      document.getElementById('appointment-date').textContent = dateDisplay;
      document.getElementById('appointment-time').innerHTML = `
        <strong style="color: var(--green); font-size: 1.1em;">${bookingData.time}</strong><br>
        <small style="color: var(--gray-600); font-style: italic;">${getTimeContext(bookingData.time)}</small>
      `;
      document.getElementById('service-address').textContent = customer.address;

      // Customer information
      document.getElementById('customer-name').textContent = customer.name;
      document.getElementById('customer-phone').textContent = customer.phone;
      document.getElementById('customer-email').textContent = customer.email;
      document.getElementById('customer-notes').textContent = customer.notes || 'None provided';
    }

    // Helper function to provide context about the appointment time
    function getTimeContext(time) {
      const timeContexts = {
        '8:00 AM': 'Early Morning Start - Our team will arrive promptly at 8:00 AM',
        '9:00 AM': 'Morning Service - Perfect time to start your tree care project',
        '10:00 AM': 'Mid-Morning Appointment - Ideal for most tree services',
        '11:00 AM': 'Late Morning Service - Great timing for outdoor work',
        '12:00 PM': 'Midday Appointment - Lunch time service slot',
        '1:00 PM': 'Early Afternoon Service - Post-lunch appointment time',
        '2:00 PM': 'Afternoon Appointment - Productive afternoon work slot',
        '3:00 PM': 'Mid-Afternoon Service - Good timing for tree care',
        '4:00 PM': 'Late Afternoon Appointment - End of day service slot'
      };
      
      return timeContexts[time] || 'Professional tree service appointment time';
    }

    // Validation function to prevent same-day and conflicting bookings
    async function validateBooking() {
      const bookingData = JSON.parse(sessionStorage.getItem('bookingData'));
      if (!bookingData) {
        alert('Booking data not found. Please try again.');
        return false;
      }

      // Show loading state
      const confirmBtn = document.querySelector('button[onclick="confirmBooking()"]');
      const originalText = confirmBtn.textContent;
      confirmBtn.textContent = 'Checking availability...';
      confirmBtn.disabled = true;

      try {
        const selectedDate = new Date(bookingData.date);
        const today = new Date();
        
        // Reset time to compare dates only
        today.setHours(0, 0, 0, 0);
        selectedDate.setHours(0, 0, 0, 0);

        // Check for same-day booking
        if (selectedDate.getTime() === today.getTime()) {
          showBookingError(
            'Same-Day Booking Not Available',
            'We require at least 24 hours notice for all appointments. Please select a date tomorrow or later.',
            'Please choose a different date'
          );
          return false;
        }

        // Check for conflicts with existing bookings
        const isConflict = await checkForBookingConflicts(bookingData.date, bookingData.time);
        if (isConflict) {
          showBookingError(
            'Time Slot Already Booked',
            `Sorry, the ${bookingData.time} time slot on ${new Date(bookingData.date).toLocaleDateString()} is no longer available.`,
            'Please select a different time'
          );
          return false;
        }

        return true;
      } catch (error) {
        console.error('Error during validation:', error);
        // Allow booking to proceed if validation fails
        return true;
      } finally {
        // Restore button state
        confirmBtn.textContent = originalText;
        confirmBtn.disabled = false;
      }
    }

    // Check for booking conflicts by querying both existing bookings and unavailable dates
    async function checkForBookingConflicts(date, time) {
      try {
        const appointmentDate = new Date(date);
        const formattedDateMDY = appointmentDate.toLocaleDateString('en-US', {
          month: '2-digit',
          day: '2-digit',
          year: 'numeric'
        });
        
        const formattedDateLong = appointmentDate.toLocaleDateString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });

        console.log(`Checking conflicts for: ${formattedDateMDY} and ${formattedDateLong} at ${time}`);

        // Check both sheets for conflicts
        const bookingsUrl = 'https://docs.google.com/spreadsheets/d/1oB7T73PHL4gdmqG4ymG20ROdkARXsSRW1-XRiyc1pBg/export?format=csv&gid=0';
        const unavailableUrl = 'https://docs.google.com/spreadsheets/d/1oB7T73PHL4gdmqG4ymG20ROdkARXsSRW1-XRiyc1pBg/export?format=csv&gid=903811488';
        
        // Check existing bookings sheet
        try {
          const bookingsResponse = await fetch(bookingsUrl + '&t=' + Date.now());
          if (bookingsResponse.ok) {
            const bookingsCsv = await bookingsResponse.text();
            const bookingLines = bookingsCsv.trim().split('\n');
            
            // Skip header and check each booking
            for (let i = 1; i < bookingLines.length; i++) {
              if (!bookingLines[i].trim()) continue;
              
              const columns = bookingLines[i].split(',');
              const csvAppointmentDate = columns[7]?.replace(/"/g, '').trim(); // Appointment Date column
              const csvAppointmentTime = columns[8]?.replace(/"/g, '').trim(); // Appointment Time column
              
              console.log(`Checking existing booking: "${csvAppointmentDate}" vs "${formattedDateLong}", "${csvAppointmentTime}" vs "${time}"`);
              
              // Check if date and time match
              if (csvAppointmentDate === formattedDateLong && csvAppointmentTime === time) {
                console.log('Conflict found in existing bookings!');
                return true;
              }
            }
          }
        } catch (error) {
          console.warn('Could not check existing bookings:', error);
        }

        // Check unavailable dates sheet
        try {
          const unavailableResponse = await fetch(unavailableUrl + '&t=' + Date.now());
          if (unavailableResponse.ok) {
            const unavailableCsv = await unavailableResponse.text();
            const unavailableLines = unavailableCsv.trim().split('\n');
            
            // Skip header and check each unavailable slot
            for (let i = 1; i < unavailableLines.length; i++) {
              if (!unavailableLines[i].trim()) continue;
              
              const columns = unavailableLines[i].split(',');
              const csvDate = columns[0]?.replace(/"/g, '').trim();
              const csvTime = columns[1]?.replace(/"/g, '').trim();
              
              console.log(`Checking unavailable slot: "${csvDate}" vs "${formattedDateMDY}", "${csvTime}" vs "${time}"`);
              
              // Check if this time slot is blocked
              if (csvDate === formattedDateMDY && csvTime === time) {
                console.log('Conflict found in unavailable dates!');
                return true;
              }
              
              // Also check for time ranges (e.g., "9:00 AM - 12:00 PM")
              if (csvDate === formattedDateMDY && csvTime.includes(' - ')) {
                const timeRange = csvTime.split(' - ');
                if (timeRange.length === 2) {
                  const startTime = timeRange[0].trim();
                  const endTime = timeRange[1].trim();
                  
                  // Simple check if the requested time falls within the range
                  // This is a basic implementation - could be enhanced for more precise time checking
                  if (isTimeInRange(time, startTime, endTime)) {
                    console.log('Conflict found in time range!');
                    return true;
                  }
                }
              }
            }
          }
        } catch (error) {
          console.warn('Could not check unavailable dates:', error);
        }
        
        console.log('No conflict found');
        return false;
      } catch (error) {
        console.error('Error checking conflicts:', error);
        return false; // If error, allow booking to proceed
      }
    }

    // Helper function to check if a time falls within a range
    function isTimeInRange(checkTime, startTime, endTime) {
      // Convert times to 24-hour format for comparison
      const parseTime = (timeStr) => {
        const [time, period] = timeStr.split(' ');
        let [hours, minutes] = time.split(':').map(Number);
        
        if (period === 'PM' && hours !== 12) hours += 12;
        if (period === 'AM' && hours === 12) hours = 0;
        
        return hours * 60 + (minutes || 0); // Return minutes since midnight
      };

      const checkMinutes = parseTime(checkTime);
      const startMinutes = parseTime(startTime);
      const endMinutes = parseTime(endTime);

      return checkMinutes >= startMinutes && checkMinutes <= endMinutes;
    }

    // Show booking error modal
    function showBookingError(title, message, actionText) {
      // Create error modal
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        font-family: 'Inter', sans-serif;
      `;

      modal.innerHTML = `
        <div style="
          background: white;
          padding: 2rem;
          border-radius: 16px;
          max-width: 500px;
          width: 90%;
          box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
          text-align: center;
        ">
          <div style="
            width: 60px;
            height: 60px;
            background: #fee2e2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem auto;
          ">
            <span style="font-size: 1.5rem; color: #dc2626;">‚ö†Ô∏è</span>
          </div>
          
          <h3 style="
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1rem;
          ">${title}</h3>
          
          <p style="
            color: #6b7280;
            line-height: 1.6;
            margin-bottom: 2rem;
            font-size: 1rem;
          ">${message}</p>
          
          <div style="display: flex; gap: 1rem; justify-content: center;">
            <button onclick="window.location.href='datetime.html'" style="
              background: #10b981;
              color: white;
              border: none;
              padding: 0.75rem 1.5rem;
              border-radius: 8px;
              font-weight: 600;
              cursor: pointer;
              font-size: 1rem;
            ">${actionText}</button>
            
            <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" style="
              background: #f3f4f6;
              color: #6b7280;
              border: none;
              padding: 0.75rem 1.5rem;
              border-radius: 8px;
              font-weight: 600;
              cursor: pointer;
              font-size: 1rem;
            ">Cancel</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Close on background click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }

    async function confirmBooking() {
      // Validate booking before submission
      const isValid = await validateBooking();
      if (!isValid) {
        return;
      }

      // Prepare booking data to send to Google Sheet
      const bookingData = JSON.parse(sessionStorage.getItem('bookingData'));
      const serviceData = JSON.parse(sessionStorage.getItem('selectedService'));
      
      // Format date and time clearly for Google Sheets
      const appointmentDate = new Date(bookingData.date);
      const formattedDate = appointmentDate.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      
      // Create comprehensive date/time description
      const dateTimeDescription = `${formattedDate} at ${bookingData.time}`;
      const timeContext = getTimeContext(bookingData.time);
      
      // Format date for unavailable dates sheet (MM/DD/YYYY format)
      const unavailableDate = appointmentDate.toLocaleDateString('en-US', {
        month: '2-digit',
        day: '2-digit',
        year: 'numeric'
      });
      
      // Get tax information from booking data
      const taxInfo = bookingData.tax || {};
      const taxAmount = taxInfo.amount || (parseFloat(serviceData.price) * 0.06);
      const totalAmount = taxInfo.total || (parseFloat(serviceData.price) + taxAmount);
      
      const dataToSend = {
        timestamp: new Date().toLocaleString('en-US'),
        name: bookingData.customer.name,
        phone: bookingData.customer.phone,
        email: bookingData.customer.email,
        address: bookingData.customer.address,
        serviceType: serviceData.packageName,
        quantity: serviceData.quantity || 1,
        propertySize: serviceData.size || '',
        appointmentDate: formattedDate,
        appointmentTime: bookingData.time,
        appointmentDateTime: dateTimeDescription,
        timeContext: timeContext,
        price: serviceData.price,
        taxLocation: taxInfo.location || 'Standard Rate',
        taxRate: taxInfo.rate ? `${(taxInfo.rate * 100).toFixed(1)}%` : '6.0%',
        taxAmount: taxAmount.toFixed(2),
        totalAmount: totalAmount.toFixed(2),
        addOns: serviceData.discountPercent > 0 ? `${serviceData.discountPercent}% bulk discount` : 'None',
        notes: bookingData.customer.notes || 'None',
        confirmationNumber: 'TPR' + Date.now().toString().substr(-6),
        // Data for blocking the time slot
        blockDate: unavailableDate,
        blockTime: bookingData.time,
        blockReason: `BOOKED - ${bookingData.customer.name}`
      };
      
      // Log the data being sent for debugging
      console.log('Booking data being sent to Google Sheets:', dataToSend);
      
      // Send to Google Apps Script
      const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx6_F7RcrDZmUcM9GFTS8xmJhRmyrP5QHHwmtmikg-NfXx4Ye2gIgEPbP-rmKw0CGZfuA/exec';
      
      fetch(GOOGLE_APPS_SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(dataToSend)
      })
      .then(response => response.json())
      .then(result => {
        // Redirect to thank you page
        window.location.href = 'thankyou.html';
      })
      .catch(error => {
        // Still redirect to thank you page even if saving fails
        window.location.href = 'thankyou.html';
      });

      // Track conversion with total amount including tax
      gtag('event', 'conversion', {
        'send_to': 'AW-16997068616/tree-service-booking',
        'value': totalAmount,
        'currency': 'USD'
      });
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      loadBookingData();
    });
  </script>
</body>
</html>
